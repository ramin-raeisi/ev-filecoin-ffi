#!/usr/bin/env bash
# shellcheck disable=SC2155 enable=require-variable-braces

set -Exeo pipefail
auth_header=()
if [ -n "${GITHUB_TOKEN}" ]; then
    auth_header=("-H" "Authorization: token ${GITHUB_TOKEN}")
fi

# set CWD to the root of filecoin-ffi
#
cd "$(dirname "${BASH_SOURCE[0]}")"

# tracks where the Rust sources are were we to build locally instead of
# downloading from GitHub Releases
#
rust_sources_dir="rust"

# tracks where the C++ sources are were we to build locally instead of
# downloading from GitHub Releases
#
cpp_sources_dir="libs/cpp-fil-proofs"

# an array of values passed as 'target-feature' to the Rust compiler if we're
# building an optimized libfilcrypto (which takes advantage of some perf-boosting
# instruction sets)
#
#optimized_release_rustc_target_features=$(jq -r '.[].rustc_target_feature' < "${rust_sources_dir}/rustc-target-features-optimized.json")

# each value in this area is checked against the "features" of the hosts CPU
# in order to determine if the host is suitable for an optimized release
#
cpu_features_required_for_optimized_release=$(jq -r '.[].check_cpu_for_feature | select(. != null)' <"${rust_sources_dir}/rustc-target-features-optimized.json")

main() {
    local __release_flags=$(get_release_flags)
    (echo >&2 "[install-filcrypto/main] building libfilcrypto from local sources (dir = ${cpp_sources_dir})")

    build_from_cpp_source "filcrypto" "${cpp_sources_dir}" "Release"

    # copy from CMake's build directory (target) to root of filecoin-ffi
    #
    #    find -L "${cpp_sources_dir}/build/release" -type f -name filcrypto.h -exec cp -- "{}" . \;
    #    find -L "${cpp_sources_dir}/build/release" -type f -name libfilcrypto.a -exec cp -- "{}" . \;
    #    find -L "${cpp_sources_dir}" -type f -name filcrypto.pc -exec cp -- "{}" . \;

    # build libfilcrypto (and corresponding header and pkg-config)
    #
    build_from_rust_source "filcrypto" "${rust_sources_dir}" "${__release_flags}"

    # copy from Rust's build directory (target) to root of filecoin-ffi
    #
    find -L "${rust_sources_dir}/target/release" -type f -name filcrypto.h -exec cp -- "{}" . \;
    find -L "${rust_sources_dir}/target/release" -type f -name libfilcrypto.a -exec cp -- "{}" . \;
    find -L "${rust_sources_dir}" -type f -name filcrypto.pc -exec cp -- "{}" . \;

    check_installed_files

    (echo >&2 "[install-filcrypto/main] successfully built and installed libfilcrypto from source")
}

build_from_cpp_source() {
    local __library_name=$1
    local __cpp_sources_path=$2
    local __release_type=$3
    local __repo_sha1=$(git rev-parse HEAD)
    local __repo_sha1_truncated="${__repo_sha1:0:16}"
    local __target_feature=""

    (echo >&2 "building from source @ ${__repo_sha1_truncated}")

    if ! [ -x "$(command -v cmake)" ]; then
        (echo >&2 '[build_from_cpp_source] Error: CMake is not installed.')
        (echo >&2 '[build_from_cpp_source] install CMake (https://cmake.org) to resolve this problem.')
        exit 1
    fi

    cmake --version

    mkdir -p ${__cpp_sources_path}/build

    pushd "${__cpp_sources_path}/build"

    cmake -DCMAKE_BUILD_TYPE=${__release_type} -DBUILD_TESTS=TRUE -DBUILD_SHARED_LIBS=TRUE ..
    cmake --build . --target multiprecision_test_bug11922
    cmake --build . --target multiprecision_test_bug12039
    cmake --build . --target multiprecision_test_compile_fail_conv_fail_01
    cmake --build . --target multiprecision_test_compile_fail_conv_fail_02
    cmake --build . --target multiprecision_test_compile_fail_conv_fail_03
    cmake --build . --target multiprecision_test_compile_fail_conv_fail_04
    cmake --build . --target multiprecision_test_compile_fail_conv_fail_05
    cmake --build . --target multiprecision_test_compile_fail_conv_fail_06
    cmake --build . --target multiprecision_test_compile_fail_conv_fail_07
    cmake --build . --target multiprecision_test_compile_fail_conv_fail_08
    cmake --build . --target multiprecision_test_compile_fail_conv_fail_09
    cmake --build . --target multiprecision_test_compile_fail_conv_fail_10
    cmake --build . --target multiprecision_test_compile_fail_conv_fail_11
    cmake --build . --target multiprecision_test_compile_fail_conv_fail_12
    cmake --build . --target multiprecision_test_compile_fail_conv_fail_13
    cmake --build . --target multiprecision_test_compile_fail_conv_fail_14
    cmake --build . --target multiprecision_test_compile_fail_conv_fail_15
    cmake --build . --target multiprecision_test_compile_fail_conv_fail_16
    cmake --build . --target multiprecision_test_compile_fail_conv_fail_18
    cmake --build . --target multiprecision_test_compile_fail_conv_fail_20
    cmake --build . --target multiprecision_test_compile_fail_conv_fail_21
    cmake --build . --target multiprecision_test_compile_fail_conv_fail_22
    cmake --build . --target multiprecision_test_compile_fail_conv_fail_23
    cmake --build . --target multiprecision_test_compile_fail_conv_fail_24
    cmake --build . --target multiprecision_test_compile_fail_conv_fail_25
    cmake --build . --target multiprecision_test_compile_fail_conv_fail_26
    cmake --build . --target multiprecision_test_compile_fail_conv_fail_27
    cmake --build . --target multiprecision_test_compile_fail_conv_fail_28
    cmake --build . --target multiprecision_test_compile_fail_conv_fail_29
    cmake --build . --target multiprecision_test_compile_fail_conv_fail_30
    cmake --build . --target multiprecision_test_compile_fail_conv_fail_31
    cmake --build . --target multiprecision_test_compile_fail_conv_fail_32
    cmake --build . --target multiprecision_test_compile_fail_conv_fail_33
    cmake --build . --target multiprecision_test_compile_fail_conv_fail_34
    cmake --build . --target multiprecision_test_compile_fail_conv_fail_35
    cmake --build . --target multiprecision_test_compile_fail_conv_fail_36
    cmake --build . --target multiprecision_test_compile_fail_conv_fail_37
    cmake --build . --target multiprecision_test_compile_fail_conv_fail_38
    cmake --build . --target multiprecision_test_compile_fail_conv_fail_39
    cmake --build . --target multiprecision_test_compile_fail_conv_fail_40
    cmake --build . --target multiprecision_test_compile_fail_conv_fail_41
    cmake --build . --target multiprecision_test_compile_fail_conv_fail_42
    cmake --build . --target multiprecision_test_compile_fail_conv_fail_43
    cmake --build . --target multiprecision_test_compile_fail_conv_fail_44
    cmake --build . --target multiprecision_test_compile_fail_conv_fail_45
    cmake --build . --target multiprecision_test_compile_fail_conv_fail_46
    cmake --build . --target multiprecision_test_compile_fail_conv_fail_47
    cmake --build . --target multiprecision_test_compile_fail_conv_fail_48
    cmake --build . --target multiprecision_test_compile_fail_conv_fail_49
    cmake --build . --target multiprecision_test_compile_fail_conv_fail_50
    cmake --build . --target multiprecision_test_compile_fail_conv_fail_51
    cmake --build . --target multiprecision_test_compile_fail_conv_fail_52
    cmake --build . --target multiprecision_test_compile_fail_conv_fail_53
    cmake --build . --target multiprecision_test_compile_fail_conv_fail_54
    cmake --build . --target multiprecision_test_compile_fail_conv_fail_55
    cmake --build . --target multiprecision_test_compile_fail_conv_fail_56
    cmake --build . --target multiprecision_test_compile_fail_conv_fail_57
    cmake --build . --target multiprecision_test_compile_fail_conv_fail_58
    cmake --build . --target multiprecision_test_compile_fail_conv_fail_59
    cmake --build . --target multiprecision_test_compile_fail_cpp_int_complement
    cmake --build . --target multiprecision_test_compile_fail_cpp_int_negate_1
    cmake --build . --target multiprecision_test_compile_fail_cpp_int_negate_2
    cmake --build . --target multiprecision_test_compile_fail_operator_fail_01
    cmake --build . --target multiprecision_test_compile_fail_operator_fail_02
    cmake --build . --target multiprecision_test_compile_fail_operator_fail_03
    cmake --build . --target multiprecision_test_compile_fail_operator_fail_04
    cmake --build . --target multiprecision_test_compile_fail_operator_fail_05
    cmake --build . --target multiprecision_test_compile_fail_operator_fail_06
    cmake --build . --target multiprecision_test_compile_fail_operator_fail_07
    cmake --build . --target multiprecision_test_compile_fail_operator_fail_08
    cmake --build . --target multiprecision_test_compile_fail_operator_fail_09
    cmake --build . --target multiprecision_test_compile_fail_operator_fail_10
    cmake --build . --target multiprecision_test_compile_fail_operator_fail_11
    cmake --build . --target multiprecision_test_compile_fail_operator_fail_12
    cmake --build . --target multiprecision_test_compile_fail_operator_fail_13
    cmake --build . --target multiprecision_test_compile_fail_operator_fail_14
    cmake --build . --target multiprecision_test_compile_fail_operator_fail_15
    cmake --build . --target multiprecision_test_compile_fail_operator_fail_16
    cmake --build . --target multiprecision_test_compile_fail_operator_fail_17
    cmake --build . --target multiprecision_test_compile_fail_operator_fail_18
    cmake --build . --target multiprecision_test_cpp_bin_float_import_export
    cmake --build . --target multiprecision_test_cpp_bin_float_snips
    cmake --build . --target multiprecision_test_cpp_dec_float
    cmake --build . --target multiprecision_test_cpp_dec_float_snips
    cmake --build . --target multiprecision_test_cpp_int_import_export
    cmake --build . --target multiprecision_test_cpp_int_snips
    cmake --build . --target multiprecision_test_debug_adaptor_snips
    cmake --build . --target multiprecision_test_floating_point_examples
    cmake --build . --target multiprecision_test_git_issue_30
    cmake --build . --target multiprecision_test_gmp_snips
    cmake --build . --target multiprecision_test_include_test_cpp_dec_float_include_test
    cmake --build . --target multiprecision_test_include_test_cpp_int_include_test
    cmake --build . --target multiprecision_test_include_test_gmp_include_test
    cmake --build . --target multiprecision_test_include_test_mpfr_include_test
    cmake --build . --target multiprecision_test_integer_examples
    cmake --build . --target multiprecision_test_issue_13148
    cmake --build . --target multiprecision_test_issue_13301
    cmake --build . --target multiprecision_test_mixed_integer_arithmetic
    cmake --build . --target multiprecision_test_modular_examples
    cmake --build . --target multiprecision_test_mpfr_snips
    cmake --build . --target multiprecision_test_safe_prime
    cmake --build . --target multiprecision_test_suite_arithmetic_tests
    cmake --build . --target multiprecision_test_suite_compile_fail
    cmake --build . --target multiprecision_test_suite_concepts
    cmake --build . --target multiprecision_test_suite_conversions
    cmake --build . --target multiprecision_test_suite_cpp_int_tests
    cmake --build . --target multiprecision_test_suite_examples
    cmake --build . --target multiprecision_test_suite_functions_and_limits
    cmake --build . --target multiprecision_test_suite_misc
    cmake --build . --target multiprecision_test_suite_specfun
    cmake --build . --target multiprecision_test_test_acos_cpp_bin_float
    cmake --build . --target multiprecision_test_test_acos_cpp_dec_float
    cmake --build . --target multiprecision_test_test_acos_mpf50
    cmake --build . --target multiprecision_test_test_acos_mpfr50
    cmake --build . --target multiprecision_test_test_adapt_serial
    cmake --build . --target multiprecision_test_test_arithmetic_ab_1
    cmake --build . --target multiprecision_test_test_arithmetic_ab_2
    cmake --build . --target multiprecision_test_test_arithmetic_ab_3
    cmake --build . --target multiprecision_test_test_arithmetic_backend_concept
    cmake --build . --target multiprecision_test_test_arithmetic_complex_adaptor
    cmake --build . --target multiprecision_test_test_arithmetic_complex_adaptor_2
    cmake --build . --target multiprecision_test_test_arithmetic_cpp_bin_float_1
    cmake --build . --target multiprecision_test_test_arithmetic_cpp_bin_float_2
    cmake --build . --target multiprecision_test_test_arithmetic_cpp_bin_float_2m
    cmake --build . --target multiprecision_test_test_arithmetic_cpp_bin_float_3
    cmake --build . --target multiprecision_test_test_arithmetic_cpp_dec_float_1
    cmake --build . --target multiprecision_test_test_arithmetic_cpp_dec_float_2
    cmake --build . --target multiprecision_test_test_arithmetic_cpp_dec_float_3
    cmake --build . --target multiprecision_test_test_arithmetic_cpp_dec_float_3m
    cmake --build . --target multiprecision_test_test_arithmetic_cpp_int_1
    cmake --build . --target multiprecision_test_test_arithmetic_cpp_int_10
    cmake --build . --target multiprecision_test_test_arithmetic_cpp_int_11
    cmake --build . --target multiprecision_test_test_arithmetic_cpp_int_12
    cmake --build . --target multiprecision_test_test_arithmetic_cpp_int_13
    cmake --build . --target multiprecision_test_test_arithmetic_cpp_int_14
    cmake --build . --target multiprecision_test_test_arithmetic_cpp_int_15
    cmake --build . --target multiprecision_test_test_arithmetic_cpp_int_16
    cmake --build . --target multiprecision_test_test_arithmetic_cpp_int_17
    cmake --build . --target multiprecision_test_test_arithmetic_cpp_int_18
    cmake --build . --target multiprecision_test_test_arithmetic_cpp_int_19
    cmake --build . --target multiprecision_test_test_arithmetic_cpp_int_2
    cmake --build . --target multiprecision_test_test_arithmetic_cpp_int_3
    cmake --build . --target multiprecision_test_test_arithmetic_cpp_int_4
    cmake --build . --target multiprecision_test_test_arithmetic_cpp_int_5
    cmake --build . --target multiprecision_test_test_arithmetic_cpp_int_6
    cmake --build . --target multiprecision_test_test_arithmetic_cpp_int_7
    cmake --build . --target multiprecision_test_test_arithmetic_cpp_int_8
    cmake --build . --target multiprecision_test_test_arithmetic_cpp_int_9
    cmake --build . --target multiprecision_test_test_arithmetic_cpp_int_br
    cmake --build . --target multiprecision_test_test_arithmetic_dbg_adptr1
    cmake --build . --target multiprecision_test_test_arithmetic_dbg_adptr1m
    cmake --build . --target multiprecision_test_test_arithmetic_dbg_adptr2
    cmake --build . --target multiprecision_test_test_arithmetic_logged_1
    cmake --build . --target multiprecision_test_test_arithmetic_logged_2
    cmake --build . --target multiprecision_test_test_arithmetic_mpc
    cmake --build . --target multiprecision_test_test_arithmetic_mpf
    cmake --build . --target multiprecision_test_test_arithmetic_mpf_50
    cmake --build . --target multiprecision_test_test_arithmetic_mpfr
    cmake --build . --target multiprecision_test_test_arithmetic_mpfr_50
    cmake --build . --target multiprecision_test_test_arithmetic_mpfr_50_static
    cmake --build . --target multiprecision_test_test_arithmetic_mpq
    cmake --build . --target multiprecision_test_test_arithmetic_mpz
    cmake --build . --target multiprecision_test_test_arithmetic_mpz_br
    cmake --build . --target multiprecision_test_test_arithmetic_mpz_rat
    cmake --build . --target multiprecision_test_test_asin_cpp_bin_float
    cmake --build . --target multiprecision_test_test_asin_cpp_dec_float
    cmake --build . --target multiprecision_test_test_asin_mpf50
    cmake --build . --target multiprecision_test_test_asin_mpfr50
    cmake --build . --target multiprecision_test_test_atan_cpp_bin_float
    cmake --build . --target multiprecision_test_test_atan_cpp_dec_float
    cmake --build . --target multiprecision_test_test_atan_mpf50
    cmake --build . --target multiprecision_test_test_atan_mpfr50
    cmake --build . --target multiprecision_test_test_checked_cpp_int
    cmake --build . --target multiprecision_test_test_checked_mixed_cpp_int
    cmake --build . --target multiprecision_test_test_constants_cpp_dec_float
    cmake --build . --target multiprecision_test_test_constants_mpf50
    cmake --build . --target multiprecision_test_test_constants_mpfr_50
    cmake --build . --target multiprecision_test_test_cos_cpp_bin_float
    cmake --build . --target multiprecision_test_test_cos_cpp_dec_float
    cmake --build . --target multiprecision_test_test_cos_mpf50
    cmake --build . --target multiprecision_test_test_cos_mpfr50
    cmake --build . --target multiprecision_test_test_cosh_cpp_bin_float
    cmake --build . --target multiprecision_test_test_cosh_cpp_dec_float
    cmake --build . --target multiprecision_test_test_cosh_mpf50
    cmake --build . --target multiprecision_test_test_cosh_mpfr50
    cmake --build . --target multiprecision_test_test_cpp_bin_float
    cmake --build . --target multiprecision_test_test_cpp_bin_float_conv
    cmake --build . --target multiprecision_test_test_cpp_bin_float_io_1
    cmake --build . --target multiprecision_test_test_cpp_bin_float_io_2
    cmake --build . --target multiprecision_test_test_cpp_dec_float_round
    cmake --build . --target multiprecision_test_test_cpp_dec_float_serial_1
    cmake --build . --target multiprecision_test_test_cpp_dec_float_serial_2
    cmake --build . --target multiprecision_test_test_cpp_int_1
    cmake --build . --target multiprecision_test_test_cpp_int_2
    cmake --build . --target multiprecision_test_test_cpp_int_3
    cmake --build . --target multiprecision_test_test_cpp_int_4
    cmake --build . --target multiprecision_test_test_cpp_int_5
    cmake --build . --target multiprecision_test_test_cpp_int_conv
    cmake --build . --target multiprecision_test_test_cpp_int_deserial
    cmake --build . --target multiprecision_test_test_cpp_int_import_export
    cmake --build . --target multiprecision_test_test_cpp_int_left_shift
    cmake --build . --target multiprecision_test_test_cpp_int_lit
    cmake --build . --target multiprecision_test_test_cpp_int_serial_1
    cmake --build . --target multiprecision_test_test_cpp_int_serial_2
    cmake --build . --target multiprecision_test_test_cpp_int_serial_3
    cmake --build . --target multiprecision_test_test_cpp_int_serial_4
    cmake --build . --target multiprecision_test_test_cpp_rat_serial
    cmake --build . --target multiprecision_test_test_exp_cpp_bin_float
    cmake --build . --target multiprecision_test_test_exp_cpp_dec_float
    cmake --build . --target multiprecision_test_test_exp_mpf50
    cmake --build . --target multiprecision_test_test_exp_mpfr50
    cmake --build . --target multiprecision_test_test_float_conversions
    cmake --build . --target multiprecision_test_test_float_io_mpf
    cmake --build . --target multiprecision_test_test_float_io_mpfr
    cmake --build . --target multiprecision_test_test_fpclassify_cpp_bin_float
    cmake --build . --target multiprecision_test_test_fpclassify_cpp_dec_float
    cmake --build . --target multiprecision_test_test_fpclassify_mpf50
    cmake --build . --target multiprecision_test_test_fpclassify_mpfr50
    cmake --build . --target multiprecision_test_test_gmp_conversions
    cmake --build . --target multiprecision_test_test_int_io_cpp_int
    cmake --build . --target multiprecision_test_test_int_io_mpz
    cmake --build . --target multiprecision_test_test_jacobi_cpp_int
    cmake --build . --target multiprecision_test_test_jacobi_gmp
    cmake --build . --target multiprecision_test_test_log_cpp_bin_float
    cmake --build . --target multiprecision_test_test_log_cpp_dec_float
    cmake --build . --target multiprecision_test_test_log_mpf50
    cmake --build . --target multiprecision_test_test_log_mpfr50
    cmake --build . --target multiprecision_test_test_miller_rabin
    cmake --build . --target multiprecision_test_test_mixed_cpp_bin_float
    cmake --build . --target multiprecision_test_test_mixed_cpp_dec_float
    cmake --build . --target multiprecision_test_test_mixed_float
    cmake --build . --target multiprecision_test_test_mixed_mpf_float
    cmake --build . --target multiprecision_test_test_mixed_mpfr_float
    cmake --build . --target multiprecision_test_test_modular_adaptor_cpp_int
    cmake --build . --target multiprecision_test_test_modular_adaptor_gmp
    cmake --build . --target multiprecision_test_test_move_cpp_int
    cmake --build . --target multiprecision_test_test_move_gmp
    cmake --build . --target multiprecision_test_test_move_mpc
    cmake --build . --target multiprecision_test_test_move_mpfr
    cmake --build . --target multiprecision_test_test_mpc_conversions
    cmake --build . --target multiprecision_test_test_mpf_precisions
    cmake --build . --target multiprecision_test_test_mpfr_conversions
    cmake --build . --target multiprecision_test_test_mpfr_mpc_precisions
    cmake --build . --target multiprecision_test_test_native_integer
    cmake --build . --target multiprecision_test_test_nothrow_cpp_bin_float
    cmake --build . --target multiprecision_test_test_nothrow_cpp_dec_float
    cmake --build . --target multiprecision_test_test_nothrow_cpp_int
    cmake --build . --target multiprecision_test_test_nothrow_cpp_rational
    cmake --build . --target multiprecision_test_test_nothrow_gmp
    cmake --build . --target multiprecision_test_test_nothrow_mpfr
    cmake --build . --target multiprecision_test_test_numeric_limits_backend_concept
    cmake --build . --target multiprecision_test_test_numeric_limits_cpp_bin_float
    cmake --build . --target multiprecision_test_test_numeric_limits_cpp_dec_float
    cmake --build . --target multiprecision_test_test_numeric_limits_cpp_int
    cmake --build . --target multiprecision_test_test_numeric_limits_mpf
    cmake --build . --target multiprecision_test_test_numeric_limits_mpf50
    cmake --build . --target multiprecision_test_test_numeric_limits_mpfr
    cmake --build . --target multiprecision_test_test_numeric_limits_mpfr_50
    cmake --build . --target multiprecision_test_test_numeric_limits_mpq
    cmake --build . --target multiprecision_test_test_numeric_limits_mpz
    cmake --build . --target multiprecision_test_test_optional_compat
    cmake --build . --target multiprecision_test_test_pow_cpp_bin_float
    cmake --build . --target multiprecision_test_test_pow_cpp_dec_float
    cmake --build . --target multiprecision_test_test_pow_mpf50
    cmake --build . --target multiprecision_test_test_pow_mpfr50
    cmake --build . --target multiprecision_test_test_rat_float_interconv_1
    cmake --build . --target multiprecision_test_test_rat_float_interconv_2
    cmake --build . --target multiprecision_test_test_rat_float_interconv_3
    cmake --build . --target multiprecision_test_test_rat_float_interconv_4
    cmake --build . --target multiprecision_test_test_rat_float_interconv_5
    cmake --build . --target multiprecision_test_test_rat_float_interconv_6
    cmake --build . --target multiprecision_test_test_rat_float_interconv_7
    cmake --build . --target multiprecision_test_test_rat_float_interconv_8
    cmake --build . --target multiprecision_test_test_rational_io_cpp_int
    cmake --build . --target multiprecision_test_test_rational_io_mpz
    cmake --build . --target multiprecision_test_test_ressol_cpp_int
    cmake --build . --target multiprecision_test_test_ressol_gmp
    cmake --build . --target multiprecision_test_test_round_cpp_bin_float
    cmake --build . --target multiprecision_test_test_round_cpp_dec_float
    cmake --build . --target multiprecision_test_test_round_mpf50
    cmake --build . --target multiprecision_test_test_round_mpfr50
    cmake --build . --target multiprecision_test_test_sf_import_c99_cpp_bin_float
    cmake --build . --target multiprecision_test_test_sf_import_c99_cpp_bin_float_2
    cmake --build . --target multiprecision_test_test_sf_import_c99_cpp_bin_float_3
    cmake --build . --target multiprecision_test_test_sf_import_c99_cpp_dec_float
    cmake --build . --target multiprecision_test_test_sf_import_c99_cpp_dec_float_2
    cmake --build . --target multiprecision_test_test_sf_import_c99_cpp_dec_float_3
    cmake --build . --target multiprecision_test_test_sf_import_c99_cpp_dec_float_4
    cmake --build . --target multiprecision_test_test_sf_import_c99_cpp_dec_float_5
    cmake --build . --target multiprecision_test_test_sf_import_c99_cpp_dec_float_6
    cmake --build . --target multiprecision_test_test_sf_import_c99_mpf50
    cmake --build . --target multiprecision_test_test_sf_import_c99_mpfr50
    cmake --build . --target multiprecision_test_test_sin_cpp_bin_float
    cmake --build . --target multiprecision_test_test_sin_cpp_dec_float
    cmake --build . --target multiprecision_test_test_sin_mpf50
    cmake --build . --target multiprecision_test_test_sin_mpfr50
    cmake --build . --target multiprecision_test_test_sinh_cpp_bin_float
    cmake --build . --target multiprecision_test_test_sinh_cpp_dec_float
    cmake --build . --target multiprecision_test_test_sinh_mpf50
    cmake --build . --target multiprecision_test_test_sinh_mpfr50
    cmake --build . --target multiprecision_test_test_sqrt_cpp_bin_float
    cmake --build . --target multiprecision_test_test_sqrt_cpp_dec_float
    cmake --build . --target multiprecision_test_test_sqrt_mpf50
    cmake --build . --target multiprecision_test_test_sqrt_mpfr50
    cmake --build . --target multiprecision_test_test_tan_cpp_bin_float
    cmake --build . --target multiprecision_test_test_tan_cpp_dec_float
    cmake --build . --target multiprecision_test_test_tan_mpf50
    cmake --build . --target multiprecision_test_test_tan_mpfr50
    cmake --build . --target multiprecision_test_test_tanh_cpp_bin_float
    cmake --build . --target multiprecision_test_test_tanh_cpp_dec_float
    cmake --build . --target multiprecision_test_test_tanh_mpf50
    cmake --build . --target multiprecision_test_test_tanh_mpfr50
    cmake --build . --target multiprecision_test_test_test
    cmake --build . --target multiprecision_test_test_unchecked_cpp_int
    cmake --build . --target multiprecision_test_ublas_interop_test1
    cmake --build . --target multiprecision_test_ublas_interop_test1_et
    cmake --build . --target multiprecision_test_ublas_interop_test2
    cmake --build . --target multiprecision_test_ublas_interop_test2_et
    cmake --build . --target multiprecision_test_ublas_interop_test4
    cmake --build . --target multiprecision_test_ublas_interop_test4_et
    cmake --build . --target multiprecision_test_ublas_interop_test5
    cmake --build . --target multiprecision_test_ublas_interop_test5_et
    cmake --build . --target multiprecision_test_ublas_interop_test6
    cmake --build . --target multiprecision_test_ublas_interop_test6_et
    cmake --build . --target multiprecision_test_ublas_interopinclude_test_cpp_bin_float_include_test
    cmake --build . --target tests-block -- -j$(nproc)
    cmake --build . --target tests-codec -- -j$(nproc)
    cmake --build . --target tests-hash -- -j$(nproc)
    cmake --build . --target tests-stream -- -j$(nproc)
    cmake --build . --target tests-core -- -j$(nproc)

    popd
}

build_from_rust_source() {
    local __library_name=$1
    local __rust_sources_path=$2
    local __release_flags=$3
    local __repo_sha1=$(git rev-parse HEAD)
    local __repo_sha1_truncated="${__repo_sha1:0:16}"

    (echo >&2 "building from source @ ${__repo_sha1_truncated}")

    if ! [ -x "$(command -v cargo)" ]; then
        (echo >&2 '[build_from_source] Error: cargo is not installed.')
        (echo >&2 '[build_from_source] install Rust toolchain to resolve this problem.')
        exit 1
    fi

    pushd "${__rust_sources_path}"

    cargo --version

    if [ -n "${__release_flags}" ]; then
        RUSTFLAGS="-C target-feature=${__release_flags}" ./scripts/build-release.sh "${__library_name}"
    else
        ./scripts/build-release.sh "${__library_name}"
    fi

    popd
}

get_release_flags() {
    local __features=""

    # determine where to look for CPU features
    #
    if [[ ! -f "/proc/cpuinfo" ]]; then
        (echo >&2 "[get_release_flags] no /proc/cpuinfo file; falling back to Darwin feature detection")
        __features=$(sysctl -a | grep machdep.cpu | tr '[:upper:]' '[:lower:]' | grep features)
    else
        #aarch64_uname=$(uname -a | grep aarch64)
        x86_64_uname=$(uname -a | grep x86_64)
        # shellcheck disable=SC2002
        if [ -n "${x86_64_uname}" ]; then
            __features=$(cat /proc/cpuinfo | grep flags | head -n 1)
        else
            # For now we assume aarch64.  If another supported platform is added, explicitly check for it
            __features=$(cat /proc/cpuinfo | grep Features | head -n 1)
        fi
    fi

    # Maps cpu flag to rust-fil-proofs flags (related to entries in libs/rust-fil-proofs/rustc-target-features-optimized
    # .json)
    feature_map=("adx:+adx" "sha_ni:+sha" "sha2:+sha2" "sse2:+sse2" "avx2:+avx2" "avx:+avx" "sse4_2:+sse4.2" "sse4_1:+sse4.1")

    target_features=""
    # check for the presence of each required CPU feature
    #
    # shellcheck disable=SC2068 # the splitting is intentional
    for x in ${cpu_features_required_for_optimized_release[@]}; do
        current_feature=$(echo "${__features}" | grep -c "${x}")
        if [ "1" = "${current_feature}" ]; then
            for feature in "${feature_map[@]}"; do
                key=${feature%%:*}
                if [ "${key}" == "${x}" ]; then
                    val=${feature#*:}
                    if [ -z "${target_features}" ]; then
                        target_features="${val}"
                    else
                        target_features="${target_features},${val}"
                    fi
                fi
            done
        fi
    done

    echo "${target_features}"
}

check_installed_files() {
    if [[ ! -f "./filcrypto.h" ]]; then
        (echo >&2 "[check_installed_files] failed to install filcrypto.h")
        exit 1
    fi

    if [[ ! -f "./libfilcrypto.a" ]]; then
        (echo >&2 "[check_installed_files] failed to install libfilcrypto.a")
        exit 1
    fi

    if [[ ! -f "./filcrypto.pc" ]]; then
        (echo >&2 "[check_installed_files] failed to install filcrypto.pc")
        exit 1
    fi
}

main "$@"
exit
